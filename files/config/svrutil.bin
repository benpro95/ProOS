#!/bin/bash
#######################
#### PVE Main Menu ####
#######################
#######################

## Time to wait for PVE action timer
wait_time=65 # seconds

##### END SESSION FUNCTION #####
ENDPGRM () {
echo " "
REPLY=""
read -p "select (s) for shell or (enter) to return: " -n 1 -r
echo
if [[ $REPLY =~ ^[Ss]$ ]]
then
  exit
else
  clear
  MAINPGRM
fi
###############################
}

##### BEGIN MAIN FUNCTION #####
MAINPGRM () {
uname -m -n -s -o -r
RANDOPT=$(( $RANDOM % 3 ))
if [[ $RANDOPT == "0" ]]
then
  echo " "
  echo "    ____             ____  _____"
  echo "   / __ \_________  / __ \/ ___/"
  echo "  / /_/ / ___/ __ \/ / / /\__ \ "
  echo " / ____/ /  / /_/ / /_/ /___/ / "
  echo "/_/   /_/   \____/\____//____/  "
  echo " "
fi
if [[ $RANDOPT == "1" ]]
then
  echo " "
  echo "  _____            ____   _____ "
  echo " |  __ \          / __ \ / ____|"
  echo " | |__) | __ ___ | |  | | (___  "
  echo " |  ___/ '__/ _ \| |  | |\___ \ "
  echo " | |   | | | (_) | |__| |____) |"
  echo " |_|   |_|  \___/ \____/|_____/ "
  echo " "
fi
if [[ $RANDOPT == "2" ]]
then
  echo " "
  echo " ____  ____   ___   ___   _____"
  echo "|    \|    \ /   \ /   \ / ___/"
  echo "|  o  )  D  )     |     (   \_ "
  echo "|   _/|    /|  O  |  O  |\__  |"
  echo "|  |  |    \|     |     |/  \ |"
  echo "|  |  |  .  \     |     |\    |"
  echo "|__|  |__|\_|\___/ \___/  \___|"
  echo " "
fi
echo "by Ben Provenzano III"
echo " "
echo "last login:"
lastlog -u server
echo " "
echo "(b) Backup utility"
echo "(l) List drive usage"
echo "(s) System configuration"
echo "(g) Generate a server log"
echo "(p) Backup ProOS to GitHub"
echo "(enter) Exit to shell"
echo " "
read -p "select option: " -n 1 -r
echo

## Backup ProOS to GitHub
if [[ $REPLY =~ ^[pP]$ ]]
then
  TIMESTMP=$(date '+%Y-%m-%d %H:%M')
  echo "Uploading changes to GitHub..."
  cd /mnt/datastore/Ben/ProOS
  git add .
  git commit -m "$TIMESTMP"
  git push -u ProOS master
  cd -
  ENDPGRM
fi

## List drive usage
if [[ $REPLY =~ ^[Ll]$ ]]
then
  echo " "
  df -h
  ENDPGRM
fi

## Generate log file
if [[ $REPLY =~ ^[Gg]$ ]]
then
  touch /mnt/extbkps/keytmp/createlog.txt
  echo " "
  echo "Wait one-minute, server log will be created at"
  echo "SMB: \\files\Downloads\Server.log"
  ENDPGRM
fi

## Server control
if [[ $REPLY =~ ^[Ss]$ ]]
then
  echo " "
  echo "(a) Update automate configuration"  
  echo "(x) Start/stop xana - vnc://ben@xana:5091"
  echo "(d) Start/stop dev - ssh://root@dev"
  echo "(u) Startup unifi controller"
  echo "(s) Stop unifi controller"
  echo "(n) Attach/detach shares"
  echo " "
  REPLY=""
  read -p "select option: " -n 1 -r
  echo
  ## Update Automate Configuration
  ##################################    
  if [[ $REPLY =~ ^[Aa]$ ]]
  then
    curl -N -f -m 1 --silent "http://ledwall:9300/exec.php?var=&arg=whtledon&action=main"
    echo " "
    echo "Updating Automate System Configuration..."
    ssh -t -i ~/ProOS/.ssh/automate.rsa root@automate.home "rm -rfv /opt/rpi/remotes"
    rsync -e "ssh -i ~/ProOS/.ssh/automate.rsa" --progress --checksum -rtv ~/ProOS/automate/config/rpi/* root@automate.home:/opt/rpi/
    echo " "
    echo "Restarting Lighttpd Web Server..."
    ssh -t -i ~/ProOS/.ssh/automate.rsa root@automate.home "systemctl restart lighttpd"
    echo " "
    echo "Restarting Unified Remote Server..."
    ssh -t -i ~/ProOS/.ssh/automate.rsa root@automate.home "systemctl restart urserver"
    curl -N -f -m 1 --silent "http://ledwall:9300/exec.php?var=&arg=whtledoff&action=main"
    REPLY=""
  fi
  ##################################  
  ## Start UniFi controller
  if [[ $REPLY =~ ^[Uu]$ ]]
  then
    echo " "
    echo "starting UniFi controller..."
    echo "access at 'https://automate.home:8443/' "
    ssh -t -i ~/ProOS/.ssh/automate.rsa root@automate.home "systemctl restart unifi"
    REPLY=""
  fi
  ## Stop UniFi controller
  if [[ $REPLY =~ ^[Ss]$ ]]
  then
    echo " "
    echo "shutting down UniFi controller..."
    ssh -t -i ~/ProOS/.ssh/automate.rsa root@automate.home "systemctl stop unifi"
    REPLY=""
  fi
  ##################################  
  ## Share Drive Access
  if [[ $REPLY =~ ^[Nn]$ ]]
  then
    echo " "
    echo "(s) Attach snapshot share"
    echo "(d) Detach snapshot share"
    echo " "
    REPLY=""
    read -p "select option: " -n 1 -r
    echo
    ## Snapshot share access
    if [[ $REPLY =~ ^[Ss]$ ]]
    then
      echo " "
      if [ -e "/mnt/backup/Snapshots" ]; then
        echo "already attached!"    
      else
        echo "attaching snapshots share..."
        ln -s /mnt/datastore/.zfs/snapshot /mnt/backup/Snapshots
      fi
    fi
    ##
    ## Archive share access
    if [[ $REPLY =~ ^[Aa]$ ]]
    then
      echo " "
      if [ -e "/mnt/backup/Archive" ]; then
        echo "already attached!"    
      else
        echo "attaching archive share..."
        ln -s /mnt/datastore/.Archive /mnt/backup/Archive
      fi
    fi
    ##
    ## Remove share access
    if [[ $REPLY =~ ^[Dd]$ ]]
    then
      echo " "
      echo "detaching shares..."
      rm -fv /mnt/backup/Snapshots
      rm -fv /mnt/backup/Archive
    fi
    REPLY=""
  fi  
  ##################################  
  ## VM control (must be last in script)
  if [[ $REPLY =~ ^[Dd]$ ]]
  then
  VMHOST="dev"
  fi
  if [[ $REPLY =~ ^[Xx]$ ]]
  then
  VMHOST="xana"
  fi
  if [[ ! $VMHOST = "" ]]
  then
    echo " "
    REPLY=""
    echo "$VMHOST virtual machine selected."
    read -p "select (b) to boot or (s) to shutdown: " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Bb]$ ]]
    then
     touch /mnt/extbkps/keytmp/start$VMHOST.txt
     temp_cnt=${wait_time}
     while [[ ${temp_cnt} -gt 0 ]];
     do
       printf "\rwait %2d second(s) for startup to trigger." ${temp_cnt}
       sleep 1
       ((temp_cnt--))
     done
     echo " "
     cat /mnt/extbkps/keytmp/vmlog.txt
    fi
    if [[ $REPLY =~ ^[Ss]$ ]]
    then
     echo "stopping $VMHOST virtual machine..."
     ssh -t -i ~/ProOS/.ssh/$VMHOST.rsa root@$VMHOST "shutdown -h now"
    fi
    VMHOST=""
    REPLY=""
  fi
  ##################################   
  ENDPGRM  
fi

## Backup to external drives (must be last)
if [[ $REPLY =~ ^[Bb]$ ]]
then
  echo " "
  echo "##################################"
  echo "#### ProServer Backup Utility ####"
  echo "##################################"
  echo " "
  echo "(a) Attach drives, start backup"
  echo "(d) Detach drives only"
  echo "(enter) drives status, start backup"
  echo " "
  REPLY=""
  read -p "enter option: " -n 1 -r
  echo
  ## Just detach drives
  if [[ $REPLY =~ ^[Dd]$ ]]
  then
    echo " "
    touch /mnt/extbkps/keytmp/unmount.txt
    temp_cnt=${wait_time}
    while [[ ${temp_cnt} -gt 0 ]];
    do
      printf "\rwait %2d second(s) for drives to detach." ${temp_cnt}
      sleep 1
      ((temp_cnt--))
    done
    cat /mnt/extbkps/keytmp/status.txt
    echo " "
    REPLY=""
    read -p "(s) re-check drives status, (enter) to skip: " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Ss]$ ]]
    then
      cat /mnt/extbkps/keytmp/status.txt
    fi
    ENDPGRM
  fi
  ## Read password then mount drives
  if [[ $REPLY =~ ^[Aa]$ ]]
  then
    echo " "
    rm -f /mnt/extbkps/keytmp/pass.txt
    read -s -p "enter backup password: " KEYVAR
    echo "$KEYVAR" >> /mnt/extbkps/keytmp/pass.txt
    KEYVAR=000000000000000000000
    echo " "
    temp_cnt=${wait_time}
    while [[ ${temp_cnt} -gt 0 ]];
    do
      printf "\rwait %2d second(s) for drives to mount." ${temp_cnt}
      sleep 1
      ((temp_cnt--))
    done
  fi
  ## Backup Drives Status
  cat /mnt/extbkps/keytmp/status.txt
  echo " "
  echo "(b) Start standard backup"
  echo "(c) Start checksum compare backup"
  echo "(s) Re-check drives status"
  echo "(enter) exit backup program"
  echo " "
  REPLY=""
  read -p "enter option: " -n 1 -r
  echo
  if [[ $REPLY =~ ^[Ss]$ ]]
  then
    cat /mnt/extbkps/keytmp/status.txt
    echo " "
    echo "(b) Start standard backup"
    echo "(c) Start checksum compare backup"
    echo "(enter) Exit backup program"
    echo " "
    REPLY=""
    read -p "enter option: " -n 1 -r
    echo
  fi
  ##
  if [[ $REPLY =~ ^[Bb]$ ]]
  then
    echo " "
    checksum="no"
    BKPPGRM
  fi
  ##
  if [[ $REPLY =~ ^[Cc]$ ]]
  then
    echo " "
    checksum="yes"
    BKPPGRM
  fi
  ENDPGRM
else
  exit
fi
##### END MAIN FUNCTION #####
}

BKPPGRM () {
##### BEGIN BACKUP FUNCTION #####
/usr/bin/svrbackup.bin $wait_time $checksum
##### END BACKUP FUNCTION #####
}

#### BEGIN MAIN SCRIPT #####
############################
### Only run if server user
if [ ! "$USER" = server ]; then
  echo "this script should only be ran by server user, aborting."
  exit
fi
############################
### Force Quit
if [ "$1" = "quit" ] ; then
  pkill svrutil.bin
  rm -f /tmp/backupsvr.lock
  echo "removed lockfile."
  exit
fi
############################
### Remove Lock Manually
if [ "$1" = "rmlock" ] ; then
  rm -f /tmp/backupsvr.lock
  echo "removed lockfile."
  exit
fi
clear
MAINPGRM
#### END MAIN SCRIPT #####
exit