#!/bin/bash
#######################
#### PVE Main Menu ####
#######################
#######################

## Time to wait for PVE action timer
wait_time=65 # seconds

##### END SESSION FUNCTION #####
ENDPGRM () {
echo " "
REPLY=""
read -p "select (s) for shell or (enter) to return: " -n 1 -r
echo
if [[ $REPLY =~ ^[Ss]$ ]]
then
  exit
else
  clear
  MAINPGRM
fi
###############################
}

##### BEGIN MAIN FUNCTION #####
MAINPGRM () {
uname -m -n -s -o -r
RANDOPT=$(( $RANDOM % 3 ))
if [[ $RANDOPT == "0" ]]
then
  echo " "
  echo "    ____             ____  _____"
  echo "   / __ \_________  / __ \/ ___/"
  echo "  / /_/ / ___/ __ \/ / / /\__ \ "
  echo " / ____/ /  / /_/ / /_/ /___/ / "
  echo "/_/   /_/   \____/\____//____/  "
  echo " "
fi
if [[ $RANDOPT == "1" ]]
then
  echo " "
  echo "  _____            ____   _____ "
  echo " |  __ \          / __ \ / ____|"
  echo " | |__) | __ ___ | |  | | (___  "
  echo " |  ___/ '__/ _ \| |  | |\___ \ "
  echo " | |   | | | (_) | |__| |____) |"
  echo " |_|   |_|  \___/ \____/|_____/ "
  echo " "
fi
if [[ $RANDOPT == "2" ]]
then
  echo " "
  echo " ____  ____   ___   ___   _____"
  echo "|    \|    \ /   \ /   \ / ___/"
  echo "|  o  )  D  )     |     (   \_ "
  echo "|   _/|    /|  O  |  O  |\__  |"
  echo "|  |  |    \|     |     |/  \ |"
  echo "|  |  |  .  \     |     |\    |"
  echo "|__|  |__|\_|\___/ \___/  \___|"
  echo " "
fi
echo "by Ben Provenzano III"
echo " "
echo "last login:"
lastlog -u server
echo " "
echo "(b) Backup utility"
echo "(l) List drive usage"
echo "(s) System configuration"
echo "(g) Generate a server log"
echo "(p) Backup ProOS to GitHub"
echo "(enter) Exit to shell"
echo " "
read -p "select mode: " -n 1 -r
echo

## Backup ProOS to GitHub
if [[ $REPLY =~ ^[pP]$ ]]
then
  TIMESTMP=$(date '+%Y-%m-%d %H:%M')
  echo "Uploading changes to GitHub..."
  cd /mnt/datastore/Ben/ProOS
  git add .
  git commit -m "$TIMESTMP"
  git push -u ProOS master
  cd -
  ENDPGRM
fi

## List drive usage
if [[ $REPLY =~ ^[Ll]$ ]]
then
  echo " "
  df -h
  ENDPGRM
fi

## Generate log file
if [[ $REPLY =~ ^[Gg]$ ]]
then
  touch /mnt/extbkps/keytmp/createlog.txt
  echo " "
  echo "Wait one-minute, server log will be created at"
  echo "SMB: \\files\Downloads\Server.log"
  ENDPGRM
fi

## Server control
if [[ $REPLY =~ ^[Ss]$ ]]
then
  echo " "
  echo "(1) Start/stop dev - ssh://root@dev/"
  echo "(2) Start/stop xana - vnc://ben@xana:5091/"
  echo "(3) Start unifi controller"
  echo "(4) Stop unifi controller"
  echo "(5) Attach snapshots share"
  echo "(6) Detach snapshots share"
  echo "(7) Update automate configuration"
  REPLY=""
  read -p "select option: " -n 1 -r
  echo
  ## Update Automate Conf
  if [[ $REPLY =~ ^[7]$ ]]
  then
    curl -N -f -m 1 --silent "http://ledwall:9300/exec.php?var=&arg=whtledon&action=main"
    echo " "
    echo "Updating Automate System Configuration..."
    ssh -t -i ~/ProOS/.ssh/automate.rsa root@automate.home "rm -rfv /opt/rpi/remotes"
    rsync -e "ssh -i ~/ProOS/.ssh/automate.rsa" --progress --checksum -rtv ~/ProOS/automate/config/rpi/* root@automate.home:/opt/rpi/
    echo " "
    echo "Restarting Lighttpd Web Server..."
    ssh -t -i ~/ProOS/.ssh/automate.rsa root@automate.home "systemctl restart lighttpd"
    echo " "
    echo "Restarting Unified Remote Server..."
    ssh -t -i ~/ProOS/.ssh/automate.rsa root@automate.home "systemctl restart urserver"
    curl -N -f -m 1 --silent "http://ledwall:9300/exec.php?var=&arg=whtledoff&action=main"
    ENDPGRM
  fi
  ## Snapshot share access
  if [[ $REPLY =~ ^[5]$ ]]
  then
    echo " "
    if [ -e "/mnt/backup/Snapshots" ]; then
      echo "already attached!"  	
    else
      echo "attaching snapshots share..."
      ln -s /mnt/datastore/.zfs/snapshot /mnt/backup/Snapshots
    fi
  fi
  ##
  ## Archive share access
  if [[ $REPLY =~ ^[Aa]$ ]]
  then
    echo " "
    if [ -e "/mnt/backup/Archive" ]; then
      echo "already attached!"  	
    else
      echo "attaching archive share..."
      ln -s /mnt/datastore/.Archive /mnt/backup/Archive
    fi
  fi
  ##
  ## Remove share access
  if [[ $REPLY =~ ^[6]$ ]]
  then
    echo " "
    echo "detaching shares..."
    rm -fv /mnt/backup/Snapshots
    rm -fv /mnt/backup/Archive
  fi
  ## Start UniFi controller
  if [[ $REPLY =~ ^[3]$ ]]
  then
    echo " "
    echo "starting UniFi controller..."
    echo "access at 'https://automate.home:8443/' "
    ssh -t -i ~/ProOS/.ssh/automate.rsa root@automate.home "systemctl restart unifi"
  fi
  ## Stop UniFi controller
  if [[ $REPLY =~ ^[4]$ ]]
  then
    echo " "
    echo "shutting down UniFi controller..."
    ssh -t -i ~/ProOS/.ssh/automate.rsa root@automate.home "systemctl stop unifi"
  fi
  ## VM control (must be last in script)
  if [[ $REPLY =~ ^[1]$ ]]
  then
  VMHOST="dev"
  fi
  ##
  if [[ $REPLY =~ ^[2]$ ]]
  then
  VMHOST="xana"
  fi
  ##
  if [[ ! $VMHOST = "" ]]
  then
    echo " "
    REPLY=""
    echo "$VMHOST virtual machine selected."
    read -p "select (b) to boot or (s) to shutdown: " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Bb]$ ]]
    then
     touch /mnt/extbkps/keytmp/start$VMHOST.txt
     temp_cnt=${wait_time}
     while [[ ${temp_cnt} -gt 0 ]];
     do
       printf "\rwait %2d second(s) for startup to trigger." ${temp_cnt}
       sleep 1
       ((temp_cnt--))
     done
     echo " "
     cat /mnt/extbkps/keytmp/vmlog.txt
    fi
    if [[ $REPLY =~ ^[Ss]$ ]]
    then
     echo "stopping $VMHOST virtual machine..."
     ssh -t -i ~/ProOS/$VMHOST/id_rsa root@$VMHOST "shutdown -h now"
    fi
  fi
  ENDPGRM  
fi

## Backup to external drives (must be last)
if [[ $REPLY =~ ^[Bb]$ ]]
then
  echo " "
  echo "##################################"
  echo "#### ProServer Backup Utility ####"
  echo "##################################"
  echo " "
  echo "(a) Attach drives, start backup"
  echo "(d) Detach drives only"
  echo "(enter) drives status, start backup"
  REPLY=""
  read -p "enter option: " -n 1 -r
  echo
  ## Just quit
  if [[ $REPLY =~ ^[Qq]$ ]]
  then
    echo " "
    ENDPGRM
  fi
  ## Just detach drives
  if [[ $REPLY =~ ^[Dd]$ ]]
  then
    echo " "
    curl -N -f -m 1 --silent "http://ledwall:9300/exec.php?var=&arg=whtledon&action=main"
    touch /mnt/extbkps/keytmp/unmount.txt
    temp_cnt=${wait_time}
    while [[ ${temp_cnt} -gt 0 ]];
    do
      printf "\rwait %2d second(s) for drives to detach." ${temp_cnt}
      sleep 1
      ((temp_cnt--))
    done
    cat /mnt/extbkps/keytmp/status.txt
    echo " "
    REPLY=""
    read -p "(s) re-check drives status, (enter) to skip: " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Ss]$ ]]
    then
      cat /mnt/extbkps/keytmp/status.txt
    fi
    curl -N -f -m 1 --silent "http://ledwall:9300/exec.php?var=&arg=whtledoff&action=main"
    ENDPGRM
  fi
  ## Read password then mount drives
  if [[ $REPLY =~ ^[Aa]$ ]]
  then
    echo " "
    rm -f /mnt/extbkps/keytmp/pass.txt
    read -s -p "enter backup password: " KEYVAR
    echo "$KEYVAR" >> /mnt/extbkps/keytmp/pass.txt
    KEYVAR=000000000000000000000
    echo " "
    curl -N -f -m 1 --silent "http://ledwall:9300/exec.php?var=&arg=whtledon&action=main"
    temp_cnt=${wait_time}
    while [[ ${temp_cnt} -gt 0 ]];
    do
      printf "\rwait %2d second(s) for drives to mount." ${temp_cnt}
      sleep 1
      ((temp_cnt--))
    done
  fi
  ## Backup Drives Status
  cat /mnt/extbkps/keytmp/status.txt
  echo " "
  echo "(b) Start standard backup"
  echo "(c) Start checksum compare backup"
  echo "(s) Re-check drives status"
  echo "(enter) exit backup program"
  REPLY=""
  read -p "enter option: " -n 1 -r
  echo
  if [[ $REPLY =~ ^[Ss]$ ]]
  then
    cat /mnt/extbkps/keytmp/status.txt
    echo " "
    echo "(b) Start standard backup"
    echo "(c) Start checksum compare backup"
    echo "(enter) Exit backup program"
    REPLY=""
    read -p "enter option: " -n 1 -r
    echo
  fi
  ##
  if [[ $REPLY =~ ^[Bb]$ ]]
  then
    echo " "
    CHECKSUM=""
    BKPPGRM
  fi
  ##
  if [[ $REPLY =~ ^[Cc]$ ]]
  then
    echo " "
    CHECKSUM="--checksum"
    BKPPGRM
  fi
  curl -N -f -m 1 --silent "http://ledwall:9300/exec.php?var=&arg=whtledoff&action=main"
  ENDPGRM
else
  exit
fi
##### END MAIN FUNCTION #####
}

BKPPGRM () {
##### BEGIN BACKUP FUNCTION #####

#### 256GB Drives ####
USB256DRV1="usb256-01"
USB256DRV2="usb256-02"
USB256DRV3=""
USB256DRV4=""
#### 128GB Drives ####
USB128DRV1="usb128-01"
USB128DRV2="usb128-02"
USB128DRV3=""
USB128DRV4=""
#### 4TB Drives ####
HDDRV1="hdd4tb-01"
HDDRV2="hdd4tb-02"
HDDRV3="hdd4tb-03"
HDDRV4=""

### Lock file
if [ -f "/tmp/backupsvr.lock" ]; then
  echo "already running!"
  echo "run 'svrutil rmlock' to manually remove lock if program failed"
  ENDPGRM
else
  touch /tmp/backupsvr.lock
fi

echo "starting backup..."
curl -N -f -m 1 --silent "http://ledwall:9300/exec.php?var=&arg=whtledon&action=main"
echo " "
echo "***************************************************"
echo "press ctrl+a then ctrl+d to detach terminal"
echo "run 'screen -r' to reattach to this terminal"
echo "***************************************************"
echo " "
if [[ "$CHECKSUM" == "--checksum" ]]
then
  echo "checksum compare option selected, this backup will take awhile!"
  echo " "
fi

###################################
###################################
## 256GB Backup Drives Loop #######
for ((i=1; i<5; i++))
do
  USB256VAR="USB256DRV$i"
  if [ "${!USB256VAR}" = "" ] ; then
    echo "no drive specified."
    echo " "
  else
    if [ ! -e /mnt/extbkps/${!USB256VAR}/Ben ] ; then
      echo "drive not connected ${!USB256VAR}"
      echo " "
    else
      ##### BEGIN BACKUP #####
      #### Ben Share ####
      if [ ! -e /mnt/datastore/Ben/ProOS ]; then
        echo "//files/Ben not connected."
      else
        echo "syncing 'Ben' share to ${!USB256VAR} drive..."
        rsync --progress $CHECKSUM -aP --exclude="Software/WindowsImageBackup/z97mx/Backup**" \
        --exclude='Software/Nintendo' --exclude='Software/Playstation' --exclude='Software/**.ipsw' \
        --exclude='Software/**VM.zip' --exclude='Software/**HD.zip' --exclude='Software/**HD.7z' \
        /mnt/datastore/Ben/ /mnt/extbkps/${!USB256VAR}/Ben/ -delete --delete-excluded
      fi
      #### Archive Share ####
      if [ ! -e /mnt/datastore/.Archive/Videos ]; then
        echo "//files/Archive not connected."
      else
        echo "syncing 'Archive' share to ${!USB256VAR} drive..."
        rsync --progress -aP --exclude="Movies/" \
        /mnt/datastore/.Archive/ /mnt/extbkps/${!USB256VAR}/.Archive/ -delete --delete-excluded
      fi
      #### Media Share ####
      if [ ! -e /mnt/datastore/Media/Music ]; then
        echo "//files/Media not connected."
      else
        echo "syncing 'Media' share to ${!USB256VAR} drive..."
        rsync --progress -aP --exclude="Movies/" --exclude="Music/" --exclude="TV Shows/" \
        /mnt/datastore/Media/ /mnt/extbkps/${!USB256VAR}/Media/ -delete --delete-excluded
      fi
      ##### END BACKUP #####
    fi
  fi  
done
###################################
###################################
## 128GB Backup Drives Loop #######
for ((i=1; i<5; i++))
do
  USB128VAR="USB128DRV$i"
  if [ "${!USB128VAR}" = "" ] ; then
    echo "no drive specified."
    echo " "
  else
    if [ ! -e /mnt/extbkps/${!USB128VAR}/Ben ]; then
      echo "drive not connected ${!USB128VAR}"
      echo " "
    else
      ##### BEGIN BACKUP #####
      #### Ben Share ####
      if [ ! -e /mnt/datastore/Ben/ProOS ]; then
        echo "//files/Ben not connected."
      else
        echo "syncing 'Ben' share to ${!USB128VAR} drive..."
        rsync --progress $CHECKSUM -aP --exclude="Software/WindowsImageBackup/z97mx/Backup**" \
        --exclude='Software/Nintendo' --exclude='Software/Playstation' --exclude='Software/**.ipsw' \
        --exclude='Software/**.img' --exclude='Software/**.iso'  --exclude='Software/**HD.zip' --exclude='Software/**HD.7z' \
        --exclude='Software/**VM.zip' --exclude='Software/**USB.zip' --exclude='Documents/Family/Media-**.zip' \
        /mnt/datastore/Ben/ /mnt/extbkps/${!USB128VAR}/Ben/ -delete --delete-excluded
      fi
      #### Archive Share ####
      if [ ! -e /mnt/datastore/.Archive/Videos ]; then
        echo "//files/Archive not connected."
      else
        echo "syncing 'Archive' share to ${!USB128VAR} drive..."
        rsync --progress -aP --exclude="Movies/" \
        /mnt/datastore/.Archive/ /mnt/extbkps/${!USB128VAR}/.Archive/ -delete --delete-excluded
      fi
      ##### END BACKUP #####
    fi
  fi  
done
###################################
###################################
## Hard Disk Backup Drives Loop ###
for ((i=1; i<5; i++))
do
  HDDVAR="HDDRV$i"
  if [ "${!HDDVAR}" = "" ] ; then
    echo "no drive specified."
    echo " "
  else
    if [ ! -e /mnt/extbkps/${!HDDVAR}/Ben ]; then
      echo "drive not connected ${!HDDVAR}"
      echo " "
    else
      ##### BEGIN BACKUP #####
      #### Ben Share ####
      if [ ! -e /mnt/datastore/Ben/ProOS ]; then
        echo "//files/Ben not connected."
      else
        echo "syncing 'Ben' share to ${!HDDVAR} drive..."
        rsync --progress $CHECKSUM -aP /mnt/datastore/Ben/ /mnt/extbkps/${!HDDVAR}/Ben/ -delete --delete-excluded
      fi
      #### Archive Share ####
      if [ ! -e /mnt/datastore/.Archive/Videos ]; then
        echo "//files/Archive not connected."
      else
        echo "syncing 'Archive' share to ${!HDDVAR} drive..."
        rsync --progress -aP /mnt/datastore/.Archive/ /mnt/extbkps/${!HDDVAR}/.Archive/ -delete --delete-excluded
      fi
      #### Media Share ####
      if [ ! -e /mnt/datastore/Media/Music ]; then
        echo "//files/Media not connected."
      else
        echo "syncing 'Media' share to ${!HDDVAR} drive..."
        rsync --progress -aP /mnt/datastore/Media/ /mnt/extbkps/${!HDDVAR}/Media/ -delete --delete-excluded
      fi
      ##### END BACKUP #####
    fi
  fi  
done

################################
## Wait for drives to settle after backup complete
temp_cnt=${wait_time}
while [[ ${temp_cnt} -gt 0 ]];
do
  printf "\rtriggering drive detach in %2d second(s)." ${temp_cnt}
  sleep 1
  ((temp_cnt--))
done
touch /mnt/extbkps/keytmp/unmount.txt
## Unlock State File
rm -f /tmp/backupsvr.lock
## Wait for drives to detach
temp_cnt=${wait_time}
while [[ ${temp_cnt} -gt 0 ]];
do
  printf "\rwait %2d second(s) for drives to detach." ${temp_cnt}
  sleep 1
  ((temp_cnt--))
done
## Print drives status
cat /mnt/extbkps/keytmp/status.txt
curl -N -f -m 1 --silent "http://ledwall:9300/exec.php?var=&arg=whtledoff&action=main"
REPLY=""
read -p "re-check drives status (s) or enter to skip: " -n 1 -r
echo
if [[ $REPLY =~ ^[Ss]$ ]]
then
  cat /mnt/extbkps/keytmp/status.txt
fi
##### END BACKUP FUNCTION #####
}


#### BEGIN MAIN SCRIPT #####
############################
### Only run if server user
if [ ! "$USER" = server ]; then
  echo "this script should only be ran by server user, aborting."
  exit 1
fi
############################
### Force Quit
if [ "$1" = "kill" ] ; then
  pkill svrutil.bin
  rm -f /tmp/backupsvr.lock
  echo "removed lockfile."
  exit
fi
if [ "$1" = "quit" ] ; then
  pkill svrutil.bin
  rm -f /tmp/backupsvr.lock
  echo "removed lockfile."
  exit
fi
############################
### Remove Lock Manually
if [ "$1" = "rmlock" ] ; then
  rm -f /tmp/backupsvr.lock
  echo "removed lockfile."
  exit
fi
sleep 0.25
clear
MAINPGRM
#### END MAIN SCRIPT #####
exit