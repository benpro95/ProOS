#!/bin/bash
##
## CameraPi by Ben Provenzano III v1.5 #############
####################################################
case "$1" in

boot)
## Video RAM Disk
mkdir -p /mnt/ramdisk
chmod 777 /mnt/ramdisk
mount -t tmpfs -o size=200m ramdisk /mnt/ramdisk
sleep 25
## Attach Server SMB Share
if ping -c 1 10.177.1.4 > /dev/null 2> /dev/null
then
  systemctl start autofs
  sleep 5.75
fi
## Google Drive
if [ ! -e /media/usb0/rclone ]; then
  echo "Flash drive not connected, not starting rclone."
else
  systemctl start rpi-rclone
  sleep 5.75
fi
## Motion Server
systemctl start motion
## Cameras Cleanup Timer
systemctl start rpi-camcleanup.timer
## IR Control
systemctl start rpi-ldr.service
## Disable HDMI
/usr/bin/tvservice -o
exit
;;

ircutoff)
## Disable IR Filter (GPIO #17)
gpio mode 0 out
gpio write 0 1
exit
;;

ircuton)
## Enable IR Filter (GPIO #17)
gpio mode 0 out
gpio write 0 0
exit
;;

iroff)
## Disable IR LEDs (GPIO #27)
gpio mode 2 out
gpio write 2 0
exit
;;

iron)
## Enable IR LEDs (GPIO #27)
gpio mode 2 out
gpio write 2 1
exit
;;

redoff)
## Disable Red LED
echo 1 | tee /sys/class/leds/led1/brightness > /dev/null 2> /dev/null
exit
;;

redon)
## Enable Red LED
echo 0 | tee /sys/class/leds/led1/brightness > /dev/null 2> /dev/null
exit
;;

cpusb)
## Copy Videos on USB Drive to Server
mkdir -p /mnt/smb/Cameras/Current/PiCam-USB
rsync -a --progress /media/usb0/cameras/ /mnt/smb/Cameras/Current/PiCam-USB/
echo "Videos can be found at '//files/Cameras/Current/PiCam-USB'"
read -p "Delete videos from USB drive? (y/n) " -n 1 -r
echo
if [[ $REPLY =~ ^[yY]$ ]]
then
  rm -rfv /media/usb0/cameras
  mkdir -p /media/usb0/cameras
  chown -R motion:motion /media/usb0/cameras
  chmod -R 777 /media/usb0/cameras
fi
exit
;;


    
        *)
	      echo " CameraPi v1"
	      echo "  by Ben Provenzano III"
	      echo " "
	      echo " ircutoff - Disable IR Filter (GPIO #17)"
	      echo " ircuton - Enable IR Filter (GPIO #17)"
	      echo " iroff - Disable IR LEDs (GPIO #27)"
	      echo " iron - Enable IR LEDs (GPIO #27)"
	      echo " redoff - Disable Red Power LED"
	      echo " redon - Enable Red Power LED"
	      echo " cpusb - Copy Videos on USB Drive to Server"
	      echo " "
	      echo " Enter a valid command argument."
          exit 1
        ;;
    esac   
