#!/bin/bash
#######################
#### PVE Main Menu ####
#######################
#######################

## Time to wait for PVE action timer
wait_time=60 # seconds

##### END SESSION FUNCTION #####
ENDPGRM () {
echo " "
REPLY=""
read -p "select (s) for shell or (enter) to return: " -n 1 -r
echo
if [[ $REPLY =~ ^[Ss]$ ]]
then
  tput clear
  exit
else
  clear
  MAINPGRM
fi
###############################
}

##### BEGIN MAIN FUNCTION #####
MAINPGRM () {
uname -m -n -s -o -r
RANDOPT=$(( $RANDOM % 3 ))
if [[ $RANDOPT == "0" ]]
then
  echo " "
  echo "    ____             ____  _____"
  echo "   / __ \_________  / __ \/ ___/"
  echo "  / /_/ / ___/ __ \/ / / /\__ \ "
  echo " / ____/ /  / /_/ / /_/ /___/ / "
  echo "/_/   /_/   \____/\____//____/  "
  echo " "
fi
if [[ $RANDOPT == "1" ]]
then
  echo " "
  echo "  _____            ____   _____ "
  echo " |  __ \          / __ \ / ____|"
  echo " | |__) | __ ___ | |  | | (___  "
  echo " |  ___/ '__/ _ \| |  | |\___ \ "
  echo " | |   | | | (_) | |__| |____) |"
  echo " |_|   |_|  \___/ \____/|_____/ "
  echo " "
fi
if [[ $RANDOPT == "2" ]]
then
  echo " "
  echo " ____  ____   ___   ___   _____"
  echo "|    \|    \ /   \ /   \ / ___/"
  echo "|  o  )  D  )     |     (   \_ "
  echo "|   _/|    /|  O  |  O  |\__  |"
  echo "|  |  |    \|     |     |/  \ |"
  echo "|  |  |  .  \     |     |\    |"
  echo "|__|  |__|\_|\___/ \___/  \___|"
  echo " "
fi
echo "by Ben Provenzano III"
echo " "
echo "last login:"
lastlog -u server
echo " "
echo "(b) backup utility"
echo "(r) attach/detach region(s)"  
echo "(enter) exit to shell"
echo " "
read -p "select option: " -n 1 -r
echo

## Backup to external drives
if [[ $REPLY =~ ^[Bb]$ ]]
then
  echo " "
  echo "##################################"
  echo "#### ProServer Backup Utility ####"
  echo "##################################"
  echo " "
  echo "(a) attach drives, start backup"
  echo "(d) detach drives only"
  echo "(enter) drives status, start backup"
  echo " "
  REPLY=""
  read -p "enter option: " -n 1 -r
  echo
  ## Just detach drives
  if [[ $REPLY =~ ^[Dd]$ ]]
  then
    echo " "
    touch /mnt/extbkps/keytmp/unmount.txt
    temp_cnt=${wait_time}
    while [[ ${temp_cnt} -gt 0 ]];
    do
      printf "\rwait %2d second(s) for drives to detach." ${temp_cnt}
      sleep 1
      ((temp_cnt--))
    done
    cat /mnt/extbkps/keytmp/status.txt
    echo " "
    REPLY=""
    read -p "(s) re-check drives status, (enter) to skip: " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Ss]$ ]]
    then
      cat /mnt/extbkps/keytmp/status.txt
    fi
    ENDPGRM
  fi
  ## Read password then mount drives
  if [[ $REPLY =~ ^[Aa]$ ]]
  then
    echo " "
    rm -f /mnt/extbkps/keytmp/pass.txt
    read -s -p "enter backup password: " KEYVAR
    echo "$KEYVAR" >> /mnt/extbkps/keytmp/pass.txt
    KEYVAR=000000000000000000000
    echo " "
    temp_cnt=${wait_time}
    while [[ ${temp_cnt} -gt 0 ]];
    do
      printf "\rwait %2d second(s) for drives to mount." ${temp_cnt}
      sleep 1
      ((temp_cnt--))
    done
  fi
  ## Backup Drives Status
  cat /mnt/extbkps/keytmp/status.txt
  echo " "
  echo "(b) start standard backup"
  echo "(c) start checksum compare backup"
  echo "(s) re-check drives status"
  echo "(enter) exit backup program"
  echo " "
  REPLY=""
  read -p "enter option: " -n 1 -r
  echo
  if [[ $REPLY =~ ^[Ss]$ ]]
  then
    cat /mnt/extbkps/keytmp/status.txt
    echo " "
    echo "(b) start standard backup"
    echo "(c) start checksum compare backup"
    echo "(enter) exit backup program"
    echo " "
    REPLY=""
    read -p "enter option: " -n 1 -r
    echo
  fi
  ##
  if [[ $REPLY =~ ^[Bb]$ ]]
  then
    echo " "
    checksum="no"
    BKPPGRM
  fi
  ##
  if [[ $REPLY =~ ^[Cc]$ ]]
  then
    echo " "
    checksum="yes"
    BKPPGRM
  fi
  ENDPGRM
fi
### runs when (enter) on main menu
tput clear
exit
##### END MAIN FUNCTION #####
}

BKPPGRM () {
##### BEGIN BACKUP FUNCTION #####
scr_num=$(echo $RANDOM) 
/usr/bin/screen -dmS $scr_num /usr/bin/svrbackup.bin $wait_time $checksum
sleep 0.25
clear
/usr/bin/screen -rS $scr_num
##### END BACKUP FUNCTION #####
}

#### BEGIN MAIN SCRIPT #####
############################
### Only run if server user
if [ ! "$USER" = server ]; then
  echo "this script should only be ran by server user, aborting."
  exit
fi
############################
### Force Quit
if [ "$1" = "quit" ] ; then
  pkill svrutil.bin
  rm -f /tmp/backupsvr.lock
  echo "removed lockfile."
  exit
fi
############################
### Remove Lock Manually
if [ "$1" = "rmlock" ] ; then
  rm -f /tmp/backupsvr.lock
  echo "removed lockfile."
  exit
fi
clear
MAINPGRM
#### END MAIN SCRIPT #####
exit