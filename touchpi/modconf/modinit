#!/bin/bash
## Pi Configuration Script v7.0

# Import Host name
HOSTNAME=`cat /opt/rpi/config/hostname`
## Set Module Path
BIN=/opt/rpi
# Import Brand name
MODNAME=`cat $BIN/modconf/brand.txt`

if [ ! -e /opt/rpi/init ]; then
echo "Core components missing or corrupted."
echo "Exiting..."
sleep 1
exit
else
echo "Components integrity verified."
fi
echo "Starting $MODNAME configuration..."

## Set LED Type
rm -f /opt/rpi/ledtype.txt
echo "8x60strips" > /opt/rpi/ledtype.txt

## Copy Boot Config
mount -o remount,rw /boot
sleep 1.25
cp -f $BIN/modconf/config.txt /boot/
mount -o remount,ro /boot

## X11 Setup
cp -f $BIN/modconf/xautostart /home/pi/.config/lxsession/LXDE/autostart
chmod 755 /home/pi/.config/lxsession/LXDE/autostart
chown pi:pi /home/pi/.config/lxsession/LXDE/autostart

## Local Root SSL Certificate
mkdir -p /usr/share/ca-certificates/local
cp -f $BIN/modconf/root_ca.crt /usr/share/ca-certificates/local/
chmod 644 /usr/share/ca-certificates/local/root_ca.crt
chown root:root /usr/share/ca-certificates/local/root_ca.crt
cp -f $BIN/modconf/intr_ca.crt /usr/share/ca-certificates/local/
chmod 644 /usr/share/ca-certificates/local/intr_ca.crt
chown root:root /usr/share/ca-certificates/local/intr_ca.crt
certutil -d sql:/home/pi/.pki/nssdb -A -t "CP,CP," -n pro_root_ca -i /usr/share/ca-certificates/local/root_ca.crt
certutil -d sql:/home/pi/.pki/nssdb -A -t "CP,CP," -n pro_intr_ca -i /usr/share/ca-certificates/local/intr_ca.crt
#dpkg-reconfigure ca-certificates

exit
